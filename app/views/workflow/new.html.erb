<%#= form_for :bpmn do |f| %>
<%#= f.file_field :bpmn %>
<%# end %>
<%= stylesheet_link_tag 'workflow' %>
<%= javascript_include_tag 'ext_lib/xml2json.min.js' %>
<%= javascript_include_tag 'ext_lib/raphael.js' %>
<%= javascript_include_tag 'workflow/bpmn.js' %>
<%= javascript_include_tag 'workflow/graffle.js' %>
<script type="text/javascript">
$(function(){

  var alreadyLoaded = false;

  // Workflow editor instructions.
  $('#help').click(function() {
    $(this).toggleClass('active');
    $('#instructions').toggleClass('hide');
  });

  var jsonObject = null;

  // WHEN YOU CLICK THE IMPORT BUTTON, IT LOADS THE JSON FROM THE SERVER
  $('#MyButton').click(function(){

    if(!alreadyLoaded){
        $.ajax({
            beforeSend: function(req) {
              req.setRequestHeader("Accept", "application/json");
            },
            url: "/workflow/xpdltojson", 
            type: "POST",
            success: function(data) {
              alreadyLoaded = true;
              jsonObject = data;
              $('#toolbox').removeClass('hide');

              // PLOTS THE WORKFLOW
              var bpmn = new net.BpmnJS(jsonObject,$('#canvas')[0]);
              bpmn.plot(jsonObject);

              // Toolbox listeners
              $('#toolbox > .tb-item').click(function(){
                var el = $(this);
                // After selecting toolbox item, the new element is drawn on the upper left corner of canvas.
                var x = 10, y= 10;
                 // var shape = null;
                 switch (el.attr('id')) {
                  case 'tb-startevent':
                  bpmn.initStartEvent(x, y);
                  break;
                  case 'tb-intermediateevent':
                  bpmn.initIntermediateEvent(x, y);
                  break;
                  case 'tb-endevent':
                  bpmn.initEndEvent(x, y);
                  break;
                  case 'tb-gateway':
                  bpmn.initGateway(x, y);
                  break;
                  case 'tb-task':
                  bpmn.initTask(x, y);
                  break;
                  case 'tb-clearcanvas':
                  if (confirm('Are you sure you want to clear the workflow?')) {
                    bpmn.clear();
                  }
                  break;
                  case 'tb-sequenceflow':
                  el.toggleClass('active hover');
                  $('#connect-instructions').toggleClass('hide');
                  bpmn.onConnect(function(e) {
                    if (e === 'success') {
                          // We have successfully connected two elements.
                          el.removeClass('active hover');
                          $('#connect-instructions').addClass('hide');
                        }
                      });
                  break;
                  default:
                      // Do nothing
                      break;
                    }
              });
            }
        });
    }
    



    // Let's use a context menu (on right-click), but happy to reconsider. :)
    // DELETE FUNCTION 
    // $(document).keyup(function(e) {
    //     switch(e.which){
    //       // DELETE WHEN "DELETE" (46) OR "BACKSPACE" (8) IS PRESSED
    //       case 46:
    //       case 8:
    //         // IT'S NOT REALLY DELETING RIGHT NOW, IT'S JUST HIDING
    //         bpmn.selectedShape.glowEffect.remove();
    //         bpmn.selectedShape.hide();
    //         if(bpmn.selectedShape.hasOwnProperty('pair')){
    //           bpmn.selectedShape.pair.hide();
    //         }
    //         break;
    //     }       
    // });

  });
});
</script>

<div id="file_input">
  <p>Select a workflow file to import.</p>
  <div class="well">
    <%= form_for :workflow, :url => {:action => "import"} do |f| %>
    <p>
      <%= f.file_field :workflow %>
    </p>
    <br />
    <%= f.submit %>
    <% end %>
  </div>
</div>
<input type="button" value="Import" id="MyButton"></input>
<br>
<div id="workflow-info" class="row">
  <div class="col-md-11"><h3 id="workflow-name">My Workflow</h3><div id="log"></div></div>
  <div class="col-md-1"><button type="button" class="btn btn-default glyphicon glyphicon-question-sign" id="help"></button></div>
</div>
<div id="instructions" class="panel panel-info hide">
  <div class="panel-heading">
    Instructions:
  </div>
  <div class="panel-body">
    <ul>
      <li>Click on a toolbox item to add it to your workflow.</li>
      <li>Right-click on a workflow item for more options (e.g. to remove item).</li>
    </ul>
  </div>
</div>
<div id="connect-instructions" class="panel panel-primary hide">
  <div class="panel-heading">
    Click on two elements in your workflow to connect them...
  </div>
</div>
<div class="btn-group hide" id="toolbox">
  <!-- The buttons with dark borders have been currently implemented (have an associated action). -->
  <button type="button" class="btn btn-default tb-item" id="tb-startevent" style="border:2px solid #333"></button>
  <button type="button" class="btn btn-default tb-item" id="tb-intermediateevent" style="border:2px solid #333"></button>
  <button type="button" class="btn btn-default tb-item" id="tb-endevent" style="border:2px solid #333"></button>
  <button type="button" class="btn btn-default tb-item" id="tb-task" style="border:2px solid #333"></button>
  <button type="button" class="btn btn-default tb-item" id="tb-transaction"></button>
  <button type="button" class="btn btn-default tb-item" id="tb-subprocess"></button>
  <button type="button" class="btn btn-default tb-item" id="tb-callactivity"></button>
  <!-- <button type="button" class="btn btn-default tb-item" id="tb-implementation"></button> -->
  <!-- <button type="button" class="btn btn-default tb-item" id="tb-edge"></button> -->
  <button type="button" class="btn btn-default tb-item" id="tb-gateway" style="border:2px solid #333"></button>
  <button type="button" class="btn btn-default tb-item" id="tb-datastore"></button>
  <button type="button" class="btn btn-default tb-item" id="tb-participant"></button>
  <button type="button" class="btn btn-default tb-item" id="tb-lane"></button>
  <!-- <button type="button" class="btn btn-default tb-item" id="tb-boundaryevent"></button> -->
  <!-- <button type="button" class="btn btn-default tb-item" id="tb-receivetask"></button> -->
  <!-- <button type="button" class="btn btn-default tb-item" id="tb-sendtask"></button> -->
  <button type="button" class="btn btn-default tb-item" id="tb-sequenceflow" style="border:2px solid #333"></button>
  <button type="button" class="btn btn-default tb-item" id="tb-messageflow"></button>
  <button type="button" class="btn btn-default tb-item" id="tb-association"></button>
  <button type="button" class="btn btn-default tb-item" id="tb-annotation"></button>
  <button type="button" class="btn btn-default tb-item" id="tb-clearcanvas" style="border:2px solid #333"></button>
</div>
<div id="canvas"></div>
<div id="editor-contextmenu" class="dropdown clearfix">
  <ul class="dropdown-menu" role="menu">
    <li><a id="add-annotation">Add Annotation...</a></li>
    <li class="divider"></li>
    <li><a id="remove-element">Remove</a></li>
  </ul>
</div>
<div id="bottom-toolbar">
  <button type="button" class="btn btn-primary" id="save">Save</button>
  <button type="button" class="btn btn-default" id="convert">Convert to JSON</button>
  <div class="btn-group">
    <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
      Export <span class="caret"></span>
    </button>
    <ul class="dropdown-menu" role="menu">
      <li><a href="#">As File...</a></li>
      <li><a href="#">As Image...</a></li>
    </ul>
  </div>
</div>
