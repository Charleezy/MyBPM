<%#= form_for :bpmn do |f| %>
  <%#= f.file_field :bpmn %>
<%# end %>
<%= javascript_include_tag 'ext_lib/xml2json.min.js' %>
<%= javascript_include_tag 'ext_lib/raphael.js' %>
<%= javascript_include_tag 'workflow/bpmn.js' %>
<script type="text/javascript">
  $(document).ready(function(){
    $('#toolbox').hide();

    var client = new XMLHttpRequest();

    // GET JSON FILE
    client.open('GET', 'https://dl.dropboxusercontent.com/s/yyimks43gemdazq/jsonFile.json?dl=1&token_hash=AAEwKPu9isScXrMb-m9dVvUkYjxLiZTsM2DcEiIvPbXFnQ',false);
    client.send();
    var jsonText = client.responseText;
    
    // GET XPDL FILE
    client.open('GET', 'https://dl.dropboxusercontent.com/s/j1w6mr83r8ug0om/simpleWorkflow.xpdl?dl=1&token_hash=AAH7PHIpUBmIim-BUM6uC7WC8lAqG-36HYOqxJHkbm2WzA',false);
    client.send();
    var XPDLText = client.responseText;

    // GET BPMN FILE
    client.open('GET', 'https://dl.dropboxusercontent.com/s/8gmm8lss2j88i1b/testFile.bpmn?dl=1&token_hash=AAGfdvQIrgIaaLbx4cpJLbFEF9izHR-iuzOhMy5esvnV1w',false);
    client.send();
    var bpmnText = client.responseText;

    // CONVERT JSON TO XPDL (NOT WORKING)
    var x2js = new X2JS();
    var newXPDLText = x2js.json2xml_str(jsonText);
    
    // CREATE THE JAVASCRIPT OBJECT BASED ON THE JSON FILE
    var jsonObject = JSON.parse(jsonText);
    console.log(jsonObject);

    // FILL THE HTML ELEMENTS WITH TEXT
    $('#json').html(jsonText);
    $('#XPDL').html(XPDLText);
    $('#bpmn').html(bpmnText);
    $('#newXPDL').html(newXPDLText);

    var alreadyLoaded = false;

    $('#MyButton').click(function(){
      $('#canvas').height(500);
      $('#canvas').width(2000);
      if(!alreadyLoaded){
          $('#toolbox').show();
          var bpmn = new net.BpmnJS($('#canvas')[0], []);
          bpmn.plot(jsonObject);
          
          // Toolbox listeners
          $('#toolbox > .tb-item').click(function(){
            var el = $(this);
            // After selecting toolbox item, we click on any location within 
            // the canvas to draw the new element there.
            $('#canvas').one('click', function(event){
              var x = event.offsetX,
                  y = event.offsetY;
              switch (el.attr('id')) {
                case 'tb-event':
                  bpmn.paintEvent(x,y,30,30,'','#efefef','black');
                  break;
                case 'tb-implementation':
                  bpmn.paintImplementation(x,y,90,60,'Text','#efefef','black');
                  break;
                case 'tb-route':
                  bpmn.paintRoute(x,y,40,40,'Text','#efefef','black');
                  break;
                case 'tb-route':
                  bpmn.paintRoute(x,y,40,40,'Text','#efefef','black');
                  break;
                default:
                  // Do nothing
              }
              
              
            });
          });

          alreadyLoaded = true;
      }
    });
  });
</script>


<input type="button" value="Import" id="MyButton"></input>
Dynamic model:
<!-- TODO needs images or some form of styling -->
<div id="toolbox" style="height:40px;border:1px solid black;">
    <span id="tb-default" class="tb-item">default</span>
    <span id="tb-event" class="tb-item">event</span>
    <span id="tb-implementation" class="tb-item">implementation</span>
    <span id="tb-route" class="tb-item">route</span>
    <span id="tb-edge" class="tb-item">edge</span>
    <span id="tb-participant" class="tb-item">participant</span>
    <span id="tb-gateway" class="tb-item">gateway</span>
    <span id="tb-lane" class="tb-item">lane</span>
    <span id="tb-boundaryevent" class="tb-item">boundaryevent</span>
    <span id="tb-receivetask" class="tb-item">receivetask</span>
    <span id="tb-sendtask" class="tb-item">sendtask</span>
    <span id="tb-subprocess" class="tb-item">subprocess</span>
    <span id="tb-datastore" class="tb-item">datastore</span>
    <span id="tb-text" class="tb-item">text</span>
    <!-- TODO other items, such as transition? -->
</div>
<div id="canvas"></div>
<%# This will get removed just keeping for testing %>
XPDL
<textarea id="XPDL" style="width:1050px;height:200px;margin:60px;"></textarea>
json
<textarea id="json" style="width:1050px;height:200px;margin:60px;"></textarea>
bpmn
<textarea id="bpmn" style="width:1050px;height:200px;margin:60px;"></textarea>
newXPDL
<textarea id="newXPDL" style="width:1050px;height:200px;margin:60px;"></textarea>
